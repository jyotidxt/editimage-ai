<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gen-Edit AI Image Editor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM from CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>

    <style>
        /* Custom styles integrated from the previous React component */
        :root {
            --bg-dark: #1a202c;
            --card-dark: #2d3748;
            --text-light: #fff;
            --text-muted: #a0aec0;
            --color-blue: #63b3ed;
            --color-blue-dark: #3182ce;
            --color-red: #c53030;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
            overflow-y: auto;
        }
        .content-wrapper {
            width: 100%;
            max-width: 64rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .main-content {
            background-color: var(--card-dark);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        @media (min-width: 768px) {
            .main-content {
                padding: 3rem;
            }
        }
        .upload-label {
            transition: background-color 0.2s;
        }
        .upload-label:hover {
            background-color: #2b6cb0;
        }
        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 2px #4299e1;
        }
        .generate-button:hover {
            background-color: #2b6cb0;
        }
        .generate-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <!-- Root element for React app -->
    <div id="root"></div>

    <script type="text/babel">
        // Use React and ReactDOM globally available via CDNs

        const { useState, useCallback, useEffect } = React;
        const rootElement = ReactDOM.createRoot(document.getElementById('root'));

        // üî¥üî¥üî¥ INSTRUCTIONS: PASTE YOUR API KEY HERE üî¥üî¥üî¥
        // 1. Visit https://aistudio.google.com/app/apikey to get a key.
        // 2. Paste your key in the quotes below.
        const API_KEY = "AIzaSyAnH3h1egIRJDz3W_OMWdwegPP69zFKWzc";
        
        const App = () => {
            // State for managing the original image preview, base64 data, and mime type
            const [originalImagePreview, setOriginalImagePreview] = useState(null);
            const [originalImageBase64, setOriginalImageBase64] = useState(null);
            const [originalImageMimeType, setOriginalImageMimeType] = useState('image/jpeg');
            // State for the edited image, user prompt, and UI status
            const [editedImage, setEditedImage] = useState(null);
            const [prompt, setPrompt] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [isEditing, setIsEditing] = useState(false);

            const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=" + API_KEY;

            // Function to handle image file selection from the user's computer
            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    // Clear previous states
                    setEditedImage(null);
                    setError('');
                    setPrompt('');

                    // Create a URL for the selected image to display it immediately
                    const imageUrl = URL.createObjectURL(file);
                    setOriginalImagePreview(imageUrl);

                    // Store the mime type
                    setOriginalImageMimeType(file.type);

                    // Convert the image to a base64 string for the API payload
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        // Only take the base64 part (after the comma)
                        const base64String = reader.result.split(',')[1]; 
                        setOriginalImageBase64(base64String);
                        setIsEditing(true); // Ready for editing
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Function to handle the image editing request
            const handleGenerate = useCallback(async () => {
                if (!API_KEY) {
                    setError('üî¥ ERROR: Please set your API_KEY inside the App component to make requests. Get a key for free at aistudio.google.com/app/apikey.');
                    return;
                }
                if (!originalImageBase64 || !prompt) {
                    setError('Please upload an image and enter a prompt.');
                    return;
                }

                setIsLoading(true);
                setError('');
                setEditedImage(null); // Clear previous result

                // Payload for the Gemini API call
                const payload = {
                    contents: [{
                        parts: [
                            {
                                // Instruction for the model to edit the image
                                text: `Edit the provided image: ${prompt}`
                            },
                            {
                                // The image to be edited
                                inlineData: {
                                    mimeType: originalImageMimeType,
                                    data: originalImageBase64
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        // Requesting both TEXT (for confirmation/debug) and IMAGE (the result)
                        responseModalities: ["TEXT", "IMAGE"] 
                    }
                };

                // Exponential backoff for API retries to handle temporary rate limits (429 errors)
                let attempt = 0;
                const maxAttempts = 5;
                const initialDelay = 1000;

                const executeRequest = async () => {
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            // Check for 429 specifically and provide a helpful message
                            if (response.status === 429) {
                                throw new Error("429 Rate Limit Exceeded. Please wait a minute before trying again.");
                            }
                            throw new Error(`API request failed with status: ${response.status}. Response: ${errorText}`);
                        }

                        const result = await response.json();
                        
                        // FIX: Replaced optional chaining (?.) with standard JavaScript checks 
                        // for compatibility with the older Babel standalone library (v6.26.0).
                        const candidate = result.candidates && result.candidates.length > 0 ? result.candidates[0] : null;

                        const base64Part = candidate && candidate.content && candidate.content.parts
                            ? candidate.content.parts.find(p => p.inlineData)
                            : null;

                        const base64Data = base64Part && base64Part.inlineData ? base64Part.inlineData.data : null;
                        const mimeType = base64Part && base64Part.inlineData ? base64Part.inlineData.mimeType : null;
                        
                        if (base64Data && mimeType) {
                            // Set the final edited image source
                            setEditedImage(`data:${mimeType};base64,${base64Data}`);
                            setIsEditing(false); // Done editing, show results
                        } else {
                            setError('Model failed to generate an image. Check your prompt or API key.');
                        }
                    } catch (e) {
                        if (attempt < maxAttempts) {
                            attempt++;
                            const delay = initialDelay * Math.pow(2, attempt - 1);
                            console.log(`Attempt ${attempt} failed. Retrying in ${delay}ms...`);
                            // Wait for the calculated delay before retrying
                            await new Promise(resolve => setTimeout(resolve, delay));
                            executeRequest(); // Recursive call to retry
                        } else {
                            setError(`Failed to connect to the API after multiple retries. Details: ${e.message}`);
                            console.error('API call failed:', e);
                        }
                    } finally {
                        setIsLoading(false);
                    }
                };

                executeRequest();
            }, [API_KEY, originalImageBase64, originalImageMimeType, prompt]);

            // SVG icon for file upload
            const UploadIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" className="icon-svg w-12 h-12" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clipRule="evenodd" />
                </svg>
            );

            // SVG icon for loading spinner
            const LoaderIcon = () => (
                <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            );


            return (
                <div className="container">
                    <div className="content-wrapper">
                        <header className="text-center">
                            <h1 className="text-5xl font-extrabold text-blue-400">Gen-Edit üñºÔ∏è</h1>
                            <p className="mt-2 text-lg text-gray-400">AI-powered image editor using the Gemini API. Upload an image, describe your edit, and let the AI do the magic!</p>
                        </header>

                        <main className="main-content">
                            {/* File Upload Section */}
                            <div className="flex flex-col items-center justify-center gap-4">
                                <label className="upload-label w-full p-6 text-center text-blue-400 font-bold border-2 border-dashed border-blue-400 rounded-lg cursor-pointer hover:bg-blue-900/50 transition-colors duration-200">
                                    <input 
                                        type="file" 
                                        onChange={handleImageUpload} 
                                        accept="image/jpeg,image/png" 
                                        className="hidden" 
                                        disabled={isLoading}
                                    />
                                    <div className="flex flex-col items-center">
                                        <UploadIcon />
                                        <span className="mt-2 text-base">
                                            {originalImagePreview && isEditing ? 'Change Image (Current Image Loaded)' : 'Click to Upload Image'}
                                        </span>
                                    </div>
                                </label>
                            </div>

                            {/* Prompt Input & Generate Button */}
                            {originalImagePreview && (
                                <div className="flex flex-col md:flex-row items-center gap-4">
                                    <input
                                        type="text"
                                        value={prompt}
                                        onChange={(e) => setPrompt(e.target.value)}
                                        placeholder="e.g., 'Add a spaceship to the sky', 'Change the shirt to blue'"
                                        className="input-field flex-grow w-full p-3 rounded-xl bg-gray-600 border border-gray-600 text-gray-100 focus:ring-2 focus:ring-blue-500"
                                        disabled={isLoading}
                                    />
                                    <button
                                        onClick={handleGenerate}
                                        disabled={isLoading || !prompt || !originalImageBase64}
                                        className="generate-button w-full md:w-auto px-6 py-3 rounded-xl font-bold text-white bg-blue-600 transition-colors duration-200 hover:bg-blue-700 flex items-center justify-center gap-2"
                                    >
                                        {/* FIX: Use React.Fragment instead of the short syntax <> to support Babel 6.26.0 */}
                                        {isLoading ? (
                                            <React.Fragment>
                                                <LoaderIcon />
                                                <span>Generating...</span>
                                            </React.Fragment>
                                        ) : 'Generate Edit'}
                                    </button>
                                </div>
                            )}

                            {/* Error Message */}
                            {error && (
                                <div className="p-4 bg-red-700 rounded-lg text-red-100 text-sm text-center">
                                    {error}
                                </div>
                            )}

                            {/* Image Display Area */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                
                                {/* Card for Original Image */}
                                {originalImagePreview && isEditing && (
                                    <div className="flex flex-col items-center gap-4 p-4 rounded-xl border border-gray-600 bg-gray-700">
                                        <h3 className="text-xl font-semibold text-gray-300">Original Image</h3>
                                        <img
                                            src={originalImagePreview}
                                            alt="Original"
                                            className="image-preview rounded-lg shadow-lg w-full h-auto max-h-96 object-contain"
                                        />
                                    </div>
                                )}
                                
                                {/* Card for Edited Image */}
                                {editedImage && (
                                    <div className="flex flex-col items-center gap-4 p-4 rounded-xl border-2 border-blue-500 bg-gray-700 shadow-xl">
                                        <h3 className="text-xl font-bold text-blue-400">Edited Image</h3>
                                        <img
                                            src={editedImage}
                                            alt="Edited"
                                            className="image-preview rounded-lg shadow-lg w-full h-auto max-h-96 object-contain"
                                        />
                                    </div>
                                )}
                                
                                {/* Placeholder when no images are loaded/ready */}
                                {!originalImagePreview && !editedImage && (
                                    <div className="col-span-1 md:col-span-2 p-16 text-center text-gray-400 border-2 border-dashed border-gray-600 rounded-xl flex items-center justify-center">
                                        <p>Upload an image to begin your AI-powered edit.</p>
                                    </div>
                                )}
                                
                                {/* Placeholder when Original is loaded and waiting for result/prompt */}
                                {originalImagePreview && !isEditing && !editedImage && !isLoading && (
                                    <div className="p-16 text-center text-gray-400 border-2 border-dashed border-gray-600 rounded-xl flex items-center justify-center">
                                        <p>Click 'Generate' to see the edited image appear here.</p>
                                    </div>
                                )}
                                {/* Loading placeholder when request is pending */}
                                {originalImagePreview && !editedImage && isLoading && (
                                    <div className="p-16 text-center text-gray-400 border-2 border-dashed border-blue-500 rounded-xl flex flex-col items-center justify-center gap-4">
                                        <LoaderIcon />
                                        <p>Generating the image edit. This may take a moment...</p>
                                    </div>
                                )}

                            </div>
                        </main>
                    </div>
                </div>
            );
        };
        
        // Render the App component
        rootElement.render(<App />);
    </script>
</body>
</html>

